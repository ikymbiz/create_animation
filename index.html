<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GenAI Cutout Parade (Direct)</title>
  <style>
    :root { --primary: #1a73e8; --bg: #202124; }
    body { margin: 0; overflow: hidden; background: var(--bg); color: white; font-family: sans-serif; }
    #ui { position: absolute; top: 15px; left: 15px; z-index: 100; background: rgba(32,33,36,0.9); padding: 20px; border-radius: 16px; width: 300px; border: 1px solid #555; }
    input, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 8px; box-sizing: border-box; }
    input { background: #333; color: white; border: 1px solid #555; }
    button { cursor: pointer; border: none; font-weight: bold; color: white; background: var(--primary); }
    button:disabled { background: #555; cursor: not-allowed; }
    #status { font-size: 12px; color: #fbbc04; margin-top: 10px; min-height: 1.4em; }
    canvas { display: block; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
</head>
<body>

<div id="ui">
  <h3 style="margin:0 0 10px 0;">Google AI Parade</h3>
  <input type="password" id="apiKey" placeholder="Gemini API Key (AI Studio)" />
  <div id="status">MediaPipe (切り抜きAI) 準備中...</div>
  <input type="file" id="upload" accept="image/*" multiple disabled />
  <button id="aiBtn" disabled>実行 (分析 & 切り抜き)</button>
  <div style="font-size:10px; color:#aaa; margin-top:10px;">
    ※Google AI Studioで作成したAPIキーを使用してください。<br>
    ※エラーが出る場合は「Web Server for Chrome」等でローカルサーバーを立てて実行してください。
  </div>
</div>

<canvas id="stage"></canvas>

<script>
  const canvas = document.getElementById('stage');
  const ctx = canvas.getContext('2d');
  const statusText = document.getElementById('status');
  const apiKeyInput = document.getElementById('apiKey');
  const aiBtn = document.getElementById('aiBtn');
  const upload = document.getElementById('upload');

  let drawings = [];
  let imageSegmenter; 

  // --- 初期化: MediaPipeの読み込み ---
  async function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';

    try {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
      );
      imageSegmenter = await ImageSegmenter.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://storage.googleapis.com/mediapipe-models/image_segmenter/deeplab_v3/float32/1/deeplab_v3.tflite",
          delegate: "GPU"
        },
        runningMode: "IMAGE",
        outputCategoryMask: true,
        outputConfidenceMask: false
      });
      statusText.textContent = "準備OK: 画像を選択してください";
      upload.disabled = false;
      aiBtn.disabled = false;
    } catch (e) {
      console.error(e);
      statusText.textContent = "エラー: AIモデル(MediaPipe)の起動に失敗。HTTPSまたはローカルサーバー経由で開いてください。";
    }
  }

  // --- Gemini APIを直接Fetchで叩く ---
  async function callGeminiDirect(apiKey, base64Image) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
    
    const payload = {
      contents: [{
        parts: [
          { text: "このキャラクターや物体の名前を一言(10文字以内)で。例:「猫」「車」" },
          { inlineData: { mimeType: "image/jpeg", data: base64Image } }
        ]
      }]
    };

    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (!response.ok) {
      // エラー詳細を取得
      const errorMsg = data.error?.message || response.statusText;
      throw new Error(`Gemini API Error: ${errorMsg}`);
    }

    return data.candidates[0].content.parts[0].text.trim();
  }

  // --- メイン処理 ---
  aiBtn.addEventListener('click', async () => {
    const key = apiKeyInput.value.trim();
    if (!key) return alert("APIキーを入力してください");
    localStorage.setItem('gemini_api_key', key);

    if (drawings.length === 0) return alert("画像を選んでください");

    statusText.textContent = "AI処理中...";
    
    try {
      for (let i = 0; i < drawings.length; i++) {
        const d = drawings[i];
        if (d.processed) continue;

        // 1. 画像をBase64化 (Gemini用)
        const base64 = d.dataUrl.split(',')[1];
        
        // 2. Gemini呼び出し
        statusText.textContent = `(${i+1}/${drawings.length}) Geminiで解析中...`;
        d.name = await callGeminiDirect(key, base64);
        
        // 3. MediaPipeで切り抜き
        statusText.textContent = `(${i+1}/${drawings.length}) 切り抜き中...`;
        const maskCanvas = await segmentImage(d.imgElement);
        d.imgCanvas = maskCanvas;
        d.processed = true;
      }
      statusText.textContent = "完了！";
    } catch (e) {
      alert(e.message);
      statusText.textContent = "エラーが発生しました";
      console.error(e);
    }
  });

  // --- 画像アップロード ---
  upload.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    for (const file of files) {
      const url = await readFileAsDataURL(file);
      const img = new Image();
      img.src = url;
      await new Promise(r => img.onload = r);
      drawings.push({
        imgElement: img, // 元画像
        imgCanvas: img,  // 表示用(あとで切り抜かれる)
        dataUrl: url,
        name: "...",
        x: Math.random() * (canvas.width - 200),
        y: Math.random() * (canvas.height - 200),
        dx: (Math.random()-0.5)*2, dy: (Math.random()-0.5)*2,
        processed: false
      });
    }
    statusText.textContent = "「実行」を押してください";
  });

  // --- MediaPipe 実行部 ---
  async function segmentImage(img) {
    const segmentationResult = await imageSegmenter.segment(img);
    const { width, height } = img;
    
    // Canvas作成
    const c = document.createElement("canvas");
    c.width = width; c.height = height;
    const ctx = c.getContext("2d");
    ctx.drawImage(img, 0, 0);
    
    const imageData = ctx.getImageData(0, 0, width, height);
    const mask = segmentationResult.categoryMask.getAsUint8Array();
    
    // 背景(0)を透明にする
    for (let i = 0; i < mask.length; i++) {
      if (mask[i] === 0) imageData.data[i * 4 + 3] = 0;
    }
    ctx.putImageData(imageData, 0, 0);
    return c;
  }

  // --- 描画ループ ---
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawings.forEach(d => {
      // 移動
      d.x += d.dx; d.y += d.dy;
      if (d.x < 0 || d.x > canvas.width - 200) d.dx *= -1;
      if (d.y < 0 || d.y > canvas.height - 200) d.dy *= -1;

      // 描画
      const w = 200; 
      const h = w * (d.imgElement.height / d.imgElement.width);
      ctx.drawImage(d.imgCanvas, d.x, d.y, w, h);
      
      // ネームプレート
      if (d.processed) {
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(d.x, d.y - 30, w, 25);
        ctx.fillStyle = "white";
        ctx.font = "16px sans-serif";
        ctx.fillText(d.name, d.x + 5, d.y - 12);
      }
    });
    requestAnimationFrame(animate);
  }
  
  function readFileAsDataURL(file) {
    return new Promise(r => {
      const reader = new FileReader();
      reader.onload = e => r(e.target.result);
      reader.readAsDataURL(file);
    });
  }

  animate();
</script>
</body>
</html>
