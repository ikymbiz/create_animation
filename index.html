<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIお絵かきパレード</title>
    <style>
        :root {
            --primary: #7e57c2;
            --danger: #ef5350;
            --success: #26a69a;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #e0f7fa;
            background-size: cover;
            background-position: center;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            touch-action: none;
        }
        #ui-layer {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-width: 300px;
            backdrop-filter: blur(4px);
        }
        h3 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.2rem; }
        .section { margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        input[type="password"], input[type="file"] {
            width: 100%;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-save { background: var(--success); color: white; }
        .btn-ai { background: var(--primary); color: white; }
        .btn-clear { background: var(--danger); color: white; }
        p { font-size: 0.75rem; color: #666; margin: 5px 0; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="ui-layer">
    <h3>AIお絵かきアプリ</h3>
    
    <div class="section">
        <p>1. Gemini APIキー設定</p>
        <input type="password" id="apiKey" placeholder="ここにAPIキーを入力">
        <button class="btn-save" id="saveKeyBtn">キーを保存</button>
    </div>

    <div class="section">
        <p>2. 絵を追加（複数OK）</p>
        <input type="file" id="upload" accept="image/*" multiple>
        <button class="btn-ai" id="aiBgBtn">AIで背景を作る</button>
    </div>

    <button class="btn-clear" id="clearBtn">画面をリセット</button>
    <p>・ドラッグで移動<br>・ダブルクリックで消去</p>
</div>

<canvas id="stage"></canvas>

<script>
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');
    const upload = document.getElementById('upload');
    const apiKeyInput = document.getElementById('apiKey');
    const saveKeyBtn = document.getElementById('saveKeyBtn');
    const aiBgBtn = document.getElementById('aiBgBtn');
    const clearBtn = document.getElementById('clearBtn');

    let drawings = [];
    let dragTarget = null;
    let dragOffsetX, dragOffsetY;

    // 初期設定
    function init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
    }
    window.addEventListener('resize', init);
    init();

    // --- クラス定義 ---
    class Drawing {
        constructor(img) {
            this.img = img;
            const ratio = img.height / img.width;
            this.width = Math.min(canvas.width, canvas.height) * 0.25;
            this.height = this.width * ratio;
            this.x = Math.random() * (canvas.width - this.width);
            this.y = Math.random() * (canvas.height - this.height);
            this.dx = (Math.random() - 0.5) * 4;
            this.dy = (Math.random() - 0.5) * 4;
            this.isDragging = false;
        }

        update() {
            if (this.isDragging) return;
            if (this.x + this.width > canvas.width || this.x < 0) this.dx *= -1;
            if (this.y + this.height > canvas.height || this.y < 0) this.dy *= -1;
            this.x += this.dx;
            this.y += this.dy;
        }

        draw() {
            ctx.drawImage(this.img, this.x, this.y, this.width, this.height);
        }

        contains(px, py) {
            return px >= this.x && px <= this.x + this.width &&
                   py >= this.y && py <= this.y + this.height;
        }
    }

    // --- ファイル読み込み ---
    upload.addEventListener('change', (e) => {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => drawings.push(new Drawing(img));
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        });
    });

    // --- インタラクション (マウス/タッチ) ---
    function getPos(e) {
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX, y: t.clientY };
    }

    function onStart(e) {
        const pos = getPos(e);
        for (let i = drawings.length - 1; i >= 0; i--) {
            if (drawings[i].contains(pos.x, pos.y)) {
                dragTarget = drawings[i];
                dragTarget.isDragging = true;
                dragOffsetX = pos.x - dragTarget.x;
                dragOffsetY = pos.y - dragTarget.y;
                // 重なり順を一番上に
                drawings.push(drawings.splice(i, 1)[0]);
                break;
            }
        }
    }

    function onMove(e) {
        if (!dragTarget) return;
        const pos = getPos(e);
        dragTarget.x = pos.x - dragOffsetX;
        dragTarget.y = pos.y - dragOffsetY;
    }

    function onEnd() {
        if (dragTarget) dragTarget.isDragging = false;
        dragTarget = null;
    }

    canvas.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);
    canvas.addEventListener('touchstart', onStart, {passive: false});
    window.addEventListener('touchmove', onMove, {passive: false});
    window.addEventListener('touchend', onEnd);

    // ダブルクリック削除
    canvas.addEventListener('dblclick', (e) => {
        const pos = getPos(e);
        drawings = drawings.filter(d => !d.contains(pos.x, pos.y));
    });

    // --- Gemini API & 背景生成 ---
    saveKeyBtn.addEventListener('click', () => {
        localStorage.setItem('gemini_api_key', apiKeyInput.value);
        alert('APIキーを保存しました。');
    });

    aiBgBtn.addEventListener('click', async () => {
        const key = apiKeyInput.value;
        if (!key) return alert("APIキーを入力してください。");
        if (drawings.length === 0) return alert("先に絵をアップロードしてください。");

        aiBgBtn.textContent = "AI解析中...";
        try {
            // 直近の画像のBase64を取得
            const lastDrawing = drawings[drawings.length - 1];
            const base64Data = lastDrawing.img.src.split(',')[1];

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: "What is the main subject of this drawing? Answer with only ONE English noun suitable for a background search (e.g. 'ocean', 'forest', 'space')." },
                            { inline_data: { mime_type: "image/png", data: base64Data } }
                        ]
                    }]
                })
            });

            const data = await response.json();
            const keyword = data.candidates[0].content.parts[0].text.trim().toLowerCase();
            
            // 背景画像の更新 (LoremFlickrを使用)
            const bgUrl = `https://loremflickr.com/1920/1080/${keyword}`;
            document.body.style.backgroundImage = `url('${bgUrl}')`;
            aiBgBtn.textContent = `背景：${keyword}`;
        } catch (err) {
            console.error(err);
            alert("AI連携に失敗しました。キーを確認してください。");
            aiBgBtn.textContent = "AIで背景を作る";
        }
    });

    clearBtn.addEventListener('click', () => {
        drawings = [];
        document.body.style.backgroundImage = 'none';
        document.body.style.backgroundColor = '#e0f7fa';
    });

    // --- ループ描画 ---
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawings.forEach(d => {
            d.update();
            d.draw();
        });
        requestAnimationFrame(animate);
    }
    animate();
</script>
</body>
</html>